#!/bin/bash
# Build a WebUI boot.iso via KIWI. The ISO will be stored in /images.
# Expects Anaconda RPMs mounted at /anaconda-rpms (RO is fine).
set -euxo pipefail

INPUT_RPMS=/anaconda-rpms/
OUT_DIR=/images/
REPO_DIR=/tmp/anaconda-rpms/

mkdir -p "$REPO_DIR"
cp -a "$INPUT_RPMS"/* "$REPO_DIR" || echo "No local Anaconda RPMs provided; proceeding with distro repos only."
createrepo_c "$REPO_DIR" || true

. /etc/os-release || true

# Global (service-level) options MUST come before `system build`
KIWI_GLOBAL_OPTS=(
  --profile=Workstation-Disk
  --kiwi-file=workstation-webui.kiwi
)

KIWI_CMD=( system build
  --description /kiwi/descriptions
  --target-dir /work/result-webui
  --add-repo type=rpm-md,alias=localanaconda,source=file://"$REPO_DIR"
)

if [[ -n "${OS_REPO:-}" ]]; then
  KIWI_CMD+=( --set-repo "type=rpm-md,alias=os,source=${OS_REPO}" )
else
  case "${ID:-}" in
    fedora)
      if [[ "${REDHAT_BUGZILLA_PRODUCT_VERSION:-}" == "rawhide" ]]; then
        branch="rawhide"
      else
        branch="${VERSION_ID:-rawhide}"
      fi
      KIWI_CMD+=( --set-repo "type=rpm-md,alias=os,source=http://dl.fedoraproject.org/pub/fedora/linux/development/${branch}/Everything/x86_64/os/" )
      ;;
    rhel|centos|almalinux|rocky)
      if [[ -z "${BASEOS_REPO:-}" || -z "${APPSTREAM_REPO:-}" ]]; then
        echo "ERROR: On RHEL-like, set BASEOS_REPO and APPSTREAM_REPO (or OS_REPO)." >&2
        exit 40
      fi
      KIWI_CMD+=( --set-repo "type=rpm-md,alias=baseos,source=${BASEOS_REPO}" )
      KIWI_CMD+=( --add-repo "type=rpm-md,alias=appstream,source=${APPSTREAM_REPO}" )
      ;;
    *)
      branch="${VERSION_ID:-rawhide}"
      KIWI_CMD+=( --set-repo "type=rpm-md,alias=os,source=http://dl.fedoraproject.org/pub/fedora/linux/development/${branch}/Everything/x86_64/os/" )
      ;;
  esac
fi

# Optional extra repo (e.g., COPR/staging)
if [[ -n "${EXTRA_REPO:-}" ]]; then
  KIWI_CMD+=( --add-repo "type=rpm-md,alias=extra,source=${EXTRA_REPO}" )
fi

# Run kiwi-ng with correct argument order
kiwi-ng "${KIWI_GLOBAL_OPTS[@]}" "${KIWI_CMD[@]}"

cp /work/result-webui/*.iso "$OUT_DIR"/
chown -Rv --reference="$INPUT_RPMS" "$OUT_DIR" || true
