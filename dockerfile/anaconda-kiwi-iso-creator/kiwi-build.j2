#!/bin/bash
# Build a boot.iso via KIWI (GTK/TUI). The ISO will be stored in /images.
# Expects Anaconda RPMs mounted at /anaconda-rpms (RO is fine).
set -euxo pipefail

INPUT_RPMS=/anaconda-rpms/
OUT_DIR=/images/
REPO_DIR=/tmp/anaconda-rpms/

# Prepare a local repo from provided Anaconda RPMs (ok if empty)
mkdir -p "$REPO_DIR"
cp -a "$INPUT_RPMS"/* "$REPO_DIR" || echo "No local Anaconda RPMs provided; proceeding with distro repos only."
createrepo_c "$REPO_DIR" || true

# Resolve base repositories (override with env if needed):
#  - OS_REPO for Fedora/ELN or custom single repo
#  - BASEOS_REPO and APPSTREAM_REPO for RHEL-like
. /etc/os-release || true

# Determine architecture for Fedora repo URL
arch="$(uname -m)"

# Global (service-level) options MUST come before `system build`
KIWI_GLOBAL_OPTS=(
  --profile=Workstation-Disk
  --kiwi-file=workstation-boot.kiwi
)

# Service command and common args
KIWI_CMD=(
  system build
  --description /kiwi/descriptions
  --target-dir /work/result-gtk
  --add-repo "type=rpm-md,alias=localanaconda,source=file://${REPO_DIR}"
)

# Select base OS repos
if [[ -n "${OS_REPO:-}" ]]; then
  KIWI_CMD+=( --set-repo "type=rpm-md,alias=os,source=${OS_REPO}" )
else
  case "${ID:-}" in
    fedora)
      if [[ "${REDHAT_BUGZILLA_PRODUCT_VERSION:-}" == "rawhide" ]]; then
        branch="rawhide"
      else
        branch="${VERSION_ID:-rawhide}"
      fi
      KIWI_CMD+=( --set-repo "type=rpm-md,alias=os,source=http://dl.fedoraproject.org/pub/fedora/linux/development/${branch}/Everything/${arch}/os/" )
      ;;
    rhel|centos|almalinux|rocky)
      if [[ -z "${BASEOS_REPO:-}" || -z "${APPSTREAM_REPO:-}" ]]; then
        echo "ERROR: On RHEL-like, set BASEOS_REPO and APPSTREAM_REPO (or OS_REPO) to proceed." >&2
        exit 40
      fi
      KIWI_CMD+=( --set-repo "type=rpm-md,alias=baseos,source=${BASEOS_REPO}" )
      KIWI_CMD+=( --add-repo "type=rpm-md,alias=appstream,source=${APPSTREAM_REPO}" )
      ;;
    *)
      branch="${VERSION_ID:-rawhide}"
      KIWI_CMD+=( --set-repo "type=rpm-md,alias=os,source=http://dl.fedoraproject.org/pub/fedora/linux/development/${branch}/Everything/${arch}/os/" )
      ;;
  esac
fi

# Optional extra repo (e.g., COPR/staging)
if [[ -n "${EXTRA_REPO:-}" ]]; then
  KIWI_CMD+=( --add-repo "type=rpm-md,alias=extra,source=${EXTRA_REPO}" )
fi

# Run kiwi-ng with correct argument order
kiwi-ng "${KIWI_GLOBAL_OPTS[@]}" "${KIWI_CMD[@]}"

# Export artifacts
cp /work/result-gtk/*.iso "$OUT_DIR"/
chown -Rv --reference="$INPUT_RPMS" "$OUT_DIR" || true
